<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Admin Orders – IRYA STONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family: Poppins, Arial; background:#f5f7fb; padding:20px }
.order {
  background:#fff;
  border-radius:12px;
  padding:15px;
  margin-bottom:15px;
  box-shadow:0 6px 20px rgba(0,0,0,.08)
}
.badge {
  padding:5px 10px;
  border-radius:6px;
  font-size:12px;
  color:#fff
}
.pending { background:#f39c12 }
.paid { background:#27ae60 }
.cancelled { background:#c0392b }
.shipped { background:#2980b9 }

button {
  padding:8px 12px;
  margin-top:6px;
  border:none;
  border-radius:6px;
  background:#2c3e50;
  color:#fff;
  cursor:pointer
}
input, select {
  width:100%;
  padding:7px;
  margin-top:5px
}
</style>
</head>

<body>

<h2>Admin Orders Panel</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collection, getDocs,
  updateDoc, doc, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ordersDiv = document.getElementById("orders");

/* LOAD ORDERS – NO DUPLICATE */
async function loadOrders() {
  ordersDiv.innerHTML = "";

  const usersSnap = await getDocs(collection(db, "users"));

  for (const user of usersSnap.docs) {
    const ordersSnap = await getDocs(
      collection(db, "users", user.id, "orders")
    );

    ordersSnap.forEach(o => {
      const d = o.data();

      ordersDiv.innerHTML += `
        <div class="order">
          <b>${o.id}</b><br>
          <span class="badge ${d.status === "cancelled" ? "cancelled" :
          d.payment.remainingAmount === 0 ? "paid" : "pending"}">
            ${d.status}
          </span>

          <p><b>${d.userName}</b> (${d.userEmail})</p>
          <p>Paid: £${d.payment.paidAmount} |
             Remaining: £${d.payment.remainingAmount}</p>

          <select id="pay-${o.id}">
            <option value="">Payment Action</option>
            <option value="confirm_full">Confirm Full Payment</option>
            <option value="cancel">Cancel Order</option>
          </select>

          <button onclick="updatePayment('${user.id}','${o.id}')">
            Update Payment
          </button>

          <input id="track-${o.id}" placeholder="Tracking Number">

          <button onclick="shipOrder('${user.id}','${o.id}')">
            Mark Shipped
          </button>
        </div>
      `;
    });
  }
}

/* PAYMENT UPDATE */
window.updatePayment = async (uid, oid) => {
  const action = document.getElementById(`pay-${oid}`).value;
  const ref = doc(db,"users",uid,"orders",oid);

  if (action === "confirm_full") {
    await updateDoc(ref,{
      status:"payment_completed",
      "payment.paidAmount": 999999,
      "payment.remainingAmount":0,
      "payment.confirmed":true,
      "payment.confirmedAt":serverTimestamp(),
      updatedAt:serverTimestamp()
    });

    await addDoc(collection(db,"users",uid,"notifications"),{
      title:"Payment Confirmed",
      message:"Your full payment has been confirmed.",
      createdAt:serverTimestamp(),
      read:false
    });
  }

  if (action === "cancel") {
    await updateDoc(ref,{
      status:"cancelled",
      cancelledAt:serverTimestamp()
    });
  }

  loadOrders();
};

/* SHIPPING */
window.shipOrder = async (uid, oid) => {
  const track = document.getElementById(`track-${oid}`).value;
  if (!track) return alert("Enter tracking");

  await updateDoc(doc(db,"users",uid,"orders",oid),{
    status:"shipped",
    shippingStatus:"shipped",
    trackingNumber:track,
    shippedAt:serverTimestamp()
  });

  await addDoc(collection(db,"users",uid,"notifications"),{
    title:"Order Shipped",
    message:`Tracking Number: ${track}`,
    createdAt:serverTimestamp(),
    read:false
  });

  loadOrders();
};

loadOrders();
</script>
</body>
</html>

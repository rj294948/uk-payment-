<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IRYA STONE â€“ Admin Orders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Segoe UI;background:#eef2f6;margin:0;padding:20px}
h2{margin-bottom:20px}
.order{
  background:#fff;
  border-radius:10px;
  padding:15px;
  margin-bottom:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.08)
}
.flex{display:flex;gap:15px}
img{width:90px;height:90px;object-fit:cover;border-radius:8px}
.badge{padding:4px 10px;border-radius:20px;font-size:12px;color:#fff}
.pending{background:#f39c12}
.full{background:#27ae60}
.cancel{background:#c0392b}
select,input,button{
  padding:8px;
  margin-top:6px;
  width:100%;
}
button{
  background:#2c3e50;color:#fff;border:none;border-radius:6px;
  cursor:pointer
}
button:hover{background:#34495e}
.small{font-size:13px;color:#555}
hr{border:none;border-top:1px solid #ddd;margin:10px 0}
</style>
</head>

<body>

<h2>ðŸ“¦ IRYA STONE â€“ Order Management</h2>
<div id="orders"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import {
  getFirestore, collectionGroup, getDocs,
  doc, updateDoc, getDoc, addDoc, collection, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDNwzhOkQQLAQbkiNFTFEGSpWJdKaxbTRk",
  authDomain: "iryastone-uk.firebaseapp.com",
  projectId: "iryastone-uk"
});

const db = getFirestore(app);
const ordersDiv = document.getElementById("orders");

/* ===== UK TIME ===== */
function ukTime(){
  return new Date().toLocaleString("en-GB",{timeZone:"Europe/London"});
}

/* ===== LIVE ORDERS ===== */
onSnapshot(collectionGroup(db,"orders"), async snap=>{
  ordersDiv.innerHTML="";

  for(const d of snap.docs){
    const o = d.data();
    if(!o.userId) continue;

    const paid = o.advancePayment || 0;
    const remaining = Math.max((o.total || 0) - paid,0);

    let img="",title="";
    const pid=o.items?.[0]?.id;
    if(pid){
      const ps=await getDoc(doc(db,"products",pid));
      if(ps.exists()){
        img=ps.data().images;
        title=ps.data().title;
      }
    }

    ordersDiv.innerHTML+=`
    <div class="order">
      <div class="flex">
        <img src="${img}">
        <div>
          <b>${title}</b><br>
          <span class="small">${o.orderNumber}</span><br>
          <span class="badge ${remaining===0?"full":"pending"}">
            ${remaining===0?"FULL PAID":"PAYMENT PENDING"}
          </span>
        </div>
      </div>

      <hr>

      <p><b>User:</b> ${o.userName} (${o.userEmail})</p>
      <p><b>Total:</b> Â£${o.total}</p>
      <p><b>Paid:</b> Â£${paid}</p>
      <p><b>Remaining:</b> Â£${remaining}</p>

      <label>Status</label>
      <select id="status-${d.id}">
        <option value="">-- Select --</option>
        <option value="payment_confirmed">Payment Confirmed</option>
        <option value="processing">Processing</option>
        <option value="ready_to_ship">Ready to Ship</option>
        <option value="shipped">Shipped</option>
        <option value="out_for_delivery">Out for Delivery</option>
        <option value="delivered">Delivered</option>
        <option value="cancelled">Cancelled</option>
      </select>

      <input id="track-${d.id}" placeholder="Tracking Number">
      <input id="delivery-${d.id}" type="datetime-local">

      <button onclick="updateOrder('${o.userId}','${d.id}','${o.orderNumber}',${paid},${o.total})">
        Update Order
      </button>

      <p class="small">
        Updated: ${o.updatedAt || "-"}<br>
        Delivered At: ${o.deliveredAt || "-"}<br>
        Cancelled At: ${o.cancelledAt || "-"}
      </p>
    </div>`;
  }
});

/* ===== UPDATE ORDER ===== */
window.updateOrder = async(userId,orderId,orderNo,paid,total)=>{
  const status=document.getElementById(`status-${orderId}`).value;
  const track=document.getElementById(`track-${orderId}`).value;
  const delivery=document.getElementById(`delivery-${orderId}`).value;

  if(!status) return alert("Select status");

  const data={
    status,
    updatedAt:ukTime(),
    remainingPayment:Math.max(total-paid,0)
  };

  let msg="";

  if(status==="shipped"){
    data.trackingNumber=track;
    data.shippedAt=ukTime();
    msg=`Order shipped. Tracking: ${track}`;
  }

  if(status==="delivered"){
    data.deliveredAt=ukTime();
    data.deliveryDateTime=delivery;
    msg="Order delivered successfully.";
  }

  if(status==="cancelled"){
    data.cancelledAt=ukTime();
    msg="Order cancelled due to payment timeout.";
  }

  await updateDoc(doc(db,"users",userId,"orders",orderId),data);

  await addDoc(collection(db,"users",userId,"notifications"),{
    title:`Order ${status.replaceAll("_"," ")}`,
    message:msg || `Order ${orderNo} updated`,
    createdAt:ukTime(),
    read:false
  });

  alert("Order updated");
};
</script>

</body>
</html>
